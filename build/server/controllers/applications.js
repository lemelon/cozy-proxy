// Generated by CoffeeScript 1.10.0
var appManager, fs, getPathForStaticApp, getProxy, lockedpath, logger, send, staticFile;

appManager = require('../lib/app_manager');

staticFile = require('node-static');

getProxy = require('../lib/proxy').getProxy;

send = require('send');

lockedpath = require('lockedpath');

fs = require('fs');

logger = require('printit')({
  date: false,
  prefix: 'controllers:applications'
});

getPathForStaticApp = function(appName, path, root, callback) {
  logger.info("Starting static app " + appName);
  if (path === '/' || path === '/public/') {
    path += 'index.html';
  }
  return callback(lockedpath(root).join(path));
};

module.exports.app = function(req, res, next) {
  var appName, shouldStart;
  appName = req.params.name;
  req.url = req.url.substring(("/apps/" + appName).length);
  shouldStart = -1 === req.url.indexOf('socket.io');
  return appManager.ensureStarted(appName, shouldStart, function(err, result) {
    var error, token;
    if (err != null) {
      error = new Error(err.msg);
      error.status = err.code;
      error.template = {
        name: err.code === 404 ? 'not_found' : 'error_app'
      };
      return next(error);
    } else if (result.type === 'static') {
      if (result.token) {
        if (req.query.token != null) {
          req.url = '/';
          token = req.query.token.slice(0, -1);
        }
        if (token !== result.token) {
          error = new Error('Not authorized to access static app');
          error.status = 401;
          next(error);
        }
      }
      return getPathForStaticApp(appName, req.url, result.path, function(url) {
        var file;
        file = new staticFile.Server(url);
        return file.serve(req, res);
      });
    } else {
      return getProxy().web(req, res, {
        target: "http://localhost:" + result.port
      });
    }
  });
};

module.exports.publicApp = function(req, res, next) {
  var appName, shouldStart;
  appName = req.params.name;
  req.url = req.url.substring(("/public/" + appName).length);
  req.url = "/public" + req.url;
  shouldStart = -1 === req.url.indexOf('socket.io');
  return appManager.ensureStarted(appName, shouldStart, function(err, result) {
    var error;
    if (err != null) {
      error = new Error(err.msg);
      error.status = err.code;
      error.template = {
        name: 'error_public'
      };
      return next(error);
    } else if (result.type === 'static') {
      return getPathForStaticApp(appName, req.url, result.path, function(url) {
        var file;
        file = new staticFile.Server(url);
        return file.serve(req, res);
      });
    } else {
      return getProxy().web(req, res, {
        target: "http://localhost:" + result.port
      });
    }
  });
};

module.exports.appWithSlash = function(req, res) {
  return res.redirect(req.url + "/");
};
